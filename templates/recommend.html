{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <h1 class="mb-4">Recommend Employees for a Task</h1>

  <!-- Form -->
  <form method="POST" class="row g-3 align-items-end mb-3">
    <div class="col-md-7">
      <label class="form-label">Select Task</label>
      <select class="form-select" name="task_id" required>
        <option value="">— Select a task —</option>

        {% for t in tasks %}
          {# support both dict styles: t["id"] or t["task_id"] #}
          {% set tid = t.get("id", t.get("task_id")) %}
          <option value="{{ tid }}" {% if selected_task_id == tid %}selected{% endif %}>
            {{ tid }} — {{ t.get("title", t.get("task_name", "Task")) }} ({{ t.get("category","") }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-5">
      <button type="submit" class="btn btn-primary w-100">Recommend</button>
    </div>
  </form>

  <!-- Task summary -->
  {% if task_obj %}
    <div class="alert alert-info">
      <strong>Task:</strong> {{ task_obj.get("title", task_obj.get("task_name","")) }}
      |
      <strong>Required skills:</strong>
      {{ task_obj.get("required_skills", []) }}
    </div>
  {% endif %}

  <!-- Results -->
  {% if recs %}
    <h3 class="mt-4">Top Recommendations</h3>

    <div class="table-responsive">
      <table class="table table-striped table-bordered align-middle mt-2">
        <thead class="table-light">
          <tr>
            <th style="width:80px;">Rank</th>
            <th>Employee</th>
            <th>Skills</th>
            <th style="width:110px;">Rating</th>
            <th style="width:120px;">Workload</th>
            <th style="width:120px;">Available</th>
            <th style="width:110px;">Score</th>
            <th>Why Recommended</th>
          </tr>
        </thead>

        <tbody>
          {% for row in recs %}
            {# row is a result dict: {"employee": {...}, "score": x, "reasons": [...]} #}
            {% set emp = row.get("employee", {}) %}
            <tr>
              <td>{{ loop.index }}</td>

              <td>
                {{ emp.get("name", emp.get("employee_name","")) }}
                {% if emp.get("id") or emp.get("employee_id") %}
                  <div class="text-muted small">{{ emp.get("id", emp.get("employee_id")) }}</div>
                {% endif %}
              </td>

              <td>
                {{ emp.get("skills", []) }}
              </td>

              <td>{{ "%.1f"|format(emp.get("avg_rating", 0)) }}</td>
              <td>{{ "%.1f"|format(emp.get("current_workload", 0)) }}</td>

              <td>
                {% if emp.get("availability", 0) == 1 %}
                  ✅
                {% else %}
                  ❌
                {% endif %}
              </td>

              <td><strong>{{ "%.2f"|format(row.get("score", 0)) }}</strong></td>

              <td>
                {% set reasons = row.get("reasons", row.get("reason", [])) %}
                {% if reasons %}
                  <ul style="margin:0; padding-left:18px;">
                    {% for r in reasons %}
                      <li>{{ r }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% else %}
    <p class="text-muted mt-3">
      No recommendations yet. Select a task and click <strong>Recommend</strong>.
    </p>
  {% endif %}

</div>
{% endblock %}

